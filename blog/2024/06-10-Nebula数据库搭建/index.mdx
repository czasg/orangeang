---
title: Nebulaæ•°æ®åº“æ­å»º
authors: [czasg]
tags: [nebula, å›¾æ•°æ®åº“]
slug: Nebulaæ•°æ®åº“æ­å»º
---

import FullScreenImage from '@site/src/components/FullScreenImage';

<!--package-->

æœ¬æ–‡è®°å½• Nebula å›¾æ•°æ®çš„æ­å»ºè¿‡ç¨‹ã€‚ <br/>
æ–‡æ¡£å‚è€ƒï¼š
- [å‡†å¤‡èµ„æº - NebulaGraph Database æ‰‹å†Œ](https://docs.nebula-graph.com.cn/3.8.0/4.deployment-and-installation/1.resource-preparations/)
- [æœ¬åœ°å®‰è£… - NebulaGraph Database æ‰‹å†Œ](https://docs.nebula-graph.com.cn/3.8.0/4.deployment-and-installation/2.compile-and-install-nebula-graph/2.install-nebula-graph-by-rpm-or-deb/)

<!--truncate-->

## æ¶æ„ç®€ä»‹
Nebula é‡‡ç”¨è®¡ç®—å­˜å‚¨åˆ†ç¦»æ¶æ„ï¼Œå…±åŒ…å«ä¸‰å¤§ç»„ä»¶ï¼š
- Graphdï¼šè´Ÿè´£å¤„ç†è®¡ç®—è¯·æ±‚
- Metadï¼šè´Ÿè´£æ•°æ®ç®¡ç†ã€é›†ç¾¤ç®¡ç†å’Œç”¨æˆ·æƒé™ç®¡ç†ç­‰
- Storagedï¼šæœåŠ¡è´Ÿè´£å­˜å‚¨æ•°æ®
ä¸‹å›¾å±•ç¤ºäº† NebulaGraph é›†ç¾¤çš„ç»å…¸æ¶æ„ï¼š

<FullScreenImage src={require("./nebula.png").default} />

å…³äº Nabula æ¶æ„æœ¬æ–‡ä¸åšè¿‡å¤šä»‹ç»ï¼Œè¯¦æƒ…è¯·è§ï¼š[NebulaGraph Database](https://docs.nebula-graph.com.cn/3.8.0/)

## å•èŠ‚ç‚¹éƒ¨ç½²

### 1.æœåŠ¡å®‰è£…
å¯ä»¥é€šè¿‡å®˜æ–¹ RPM åŒ…å®‰è£… NebulaGraphï¼Œæœ¬æ¬¡å®‰è£…ç‰ˆæœ¬3.8.0ã€‚
é»˜è®¤å®‰è£…è·¯å¾„ä¸º `/usr/local/nebula/`ã€‚
```bash
wget https://oss-cdn.nebula-graph.com.cn/package/3.8.0/nebula-graph-3.8.0.el7.x86_64.rpm
rpm -ivh nebula-graph-3.8.0.el7.x86_64.rpm
```

### 2.é…ç½®åˆå§‹åŒ–
Nebula æä¾›äº†é»˜è®¤ .default å’Œç”Ÿäº§ .production ä¸¤ç§é…ç½®ã€‚
æˆ‘ä»¬é‡‡ç”¨ production é…ç½®ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šåšä¸€å®šçš„è°ƒæ•´ï¼š
#### 2.1.MetaæœåŠ¡é…ç½®
é…ç½®æ–‡ä»¶è·¯å¾„ï¼š/usr/local/nebula/etc/nebula-metad.conf
é…ç½®è°ƒæ•´é¡¹ï¼š
```
--timezone_name=UTC+08:00
--log_dir=/workspace/logs/nebula
--timestamp_in_logfile_name=true
--max_log_size=1024
--data_path=/workspace/data/nebula/meta
```

#### 2.2.GraphæœåŠ¡é…ç½®
é…ç½®æ–‡ä»¶è·¯å¾„ï¼š/usr/local/nebula/etc/nebula-graphd.conf
é…ç½®è°ƒæ•´é¡¹ï¼š
```
--timezone_name=UTC+08:00
--log_dir=/workspace/logs/nebula
--timestamp_in_logfile_name=true
--max_log_size=1024
--enable_authorize=true
--enable_space_level_metrics=true
--max_sessions_per_ip_per_user=500
```

#### 2.3.StorageæœåŠ¡é…ç½®
é…ç½®æ–‡ä»¶è·¯å¾„ï¼š/usr/local/nebula/etc/nebula-storage.conf
é…ç½®è°ƒæ•´é¡¹ï¼š
```
--timezone_name=UTC+08:00
--log_dir=/workspace/logs/nebula
--timestamp_in_logfile_name=true
--max_log_size=1024
--data_path=/workspace/data/nebula/storage
```

### 5.2.æœåŠ¡å¯åŠ¨
Nebula æ¶‰åŠä¸‰ä¸ªæœåŠ¡ç»„ä»¶ï¼ˆgraphdã€metadã€storagedï¼‰ï¼Œå…¶ä¸­ metad å¼‚å¸¸æ—¶æ•°æ®åº“ä»æ—§å¯ä»¥æä¾›æ­£å¸¸è¯»ï¼Œå…¶ä½™ç»„ä»¶å¼‚å¸¸åˆ™æ•´ä½“æœåŠ¡å¼‚å¸¸ã€‚ç»¼åˆè€ƒè™‘ï¼Œé‡‡ç”¨ Supervisor éƒ¨ç½² Nebula ç›¸å…³æœåŠ¡ã€‚

```bash title="nebula-supervisor.ini"
[program:nebula-supervisor]
command=/usr/local/nebula/scripts/nebula-supervisor.sh
directory=/workspace/app/nebula
user=root
autostart=true
autorestart=true
startsecs=2
startretries=2
stopsignal=TERM
stopwaitsecs=10
stopasgroup=true
stdout_logfile=/workspace/logs/nebula/nebula-supervisor.log
stderr_logfile=/workspace/logs/nebula/nebula-supervisor.err
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
```

```bash title="nebula-supervisor.sh"
#!/bin/bash

# nebula å¯åŠ¨å…¥å£
function start_nebula() {
/usr/local/nebula/scripts/nebula.service start $1
if [ $? -eq 0 ]; then
echo "$(date): $1 æœåŠ¡å¯åŠ¨æˆåŠŸã€‚"
else
echo "$(date): $1 æœåŠ¡å¯åŠ¨å¤±è´¥ã€‚"
fi
}

# å®šä¹‰æœåŠ¡
items=("metad" "graphd" "storaged")

while true; do  # æ— é™å¾ªç¯
for item in "${items[@]}"; do  # éå†åˆ—è¡¨ä¸­çš„æ¯ä¸ªå…ƒç´ 
if ! pgrep -x "nebula-$item" > /dev/null  # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦å­˜åœ¨
then
echo "$(date): nebula-$item è¿›ç¨‹ä¸å­˜åœ¨ï¼Œæ­£åœ¨å¯åŠ¨æœåŠ¡..."
start_nebula $item
else
echo "$(date): nebula-$item è¿›ç¨‹æ­£åœ¨è¿è¡Œã€‚"
fi
done
sleep 60  # æš‚åœ60ç§’
done
```
æ›´æ–°ä¸‹ supervisor ç®¡ç†è¿›ç¨‹ï¼š
```bash
supervisorctl reread
supervisorctl update
```
æ­¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å·²ç»è·‘èµ·æ¥äº†ä¸‰ä¸ªè¿›ç¨‹ï¼š
```bash
$ ps -ef | grep nebula
root     22026     1  0 12:31 ?        00:00:07 /usr/local/nebula/bin/nebula-metad --flagfile /usr/local/nebula/etc/nebula-metad.conf
root     28838     1  0 May31 ?        00:00:31 /usr/local/nebula/bin/nebula-graphd --flagfile /usr/local/nebula/etc/nebula-graphd.conf
root     28926     1  0 May31 ?        00:02:06 /usr/local/nebula/bin/nebula-storaged --flagfile /usr/local/nebula/etc/nebula-storaged.conf
```
### 5.3.æ—¥å¿—åˆå§‹åŒ–
æ—¥å¿—æš‚æ—¶ä¸ç”¨æ”¶é›†ï¼Œä½†ä»ç„¶å»ºè®®å®šæœŸæ¸…é™¤ã€‚
è®¡åˆ’æ¯å¤©å‡Œæ™¨ 3 ç‚¹è‡ªåŠ¨åˆ é™¤æ›´æ–°æ—¶é—´è¶…è¿‡ 7 å¤©çš„ Graph æœåŠ¡è¿è¡Œæ—¥å¿—æ–‡ä»¶ã€‚
Crontab æŒ‡ä»¤å‚è€ƒå¦‚ä¸‹ï¼š
```
0 3 * * * find /workspace/logs/nebula -name nebula-graphd.* -mtime +7 -delete
```
5.4.ç”¨æˆ·åˆå§‹åŒ–
```
CREATE USER develop WITH PASSWORD 'develop';
GRANT ROLE USER ON develop TO develop;
```

5.5.æ³¨å†ŒæœåŠ¡
Nebula æœåŠ¡å¯åŠ¨åä¸ä¼šè‡ªåŠ¨æ‰§è¡Œæ³¨å†Œï¼Œè€Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨æ³¨å†Œ Storage æœåŠ¡ã€‚
å»ºè®®ä½¿ç”¨ docker åœ¨æœ¬åœ°æ­å»ºä¸€ä¸ª studio æœåŠ¡ï¼Œdocker æŒ‡ä»¤å‚è€ƒå¦‚ä¸‹ï¼š
```
docker run -it --rm -p 7001:7001 -e USER=root vesoft/nebula-graph-studio:v3.10
```
åœ¨ studio / console ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹æŒ‡ä»¤æ·»åŠ  Storage ä¸»æœº
```
ADD HOST 127.0.0.1:9779
```
è‡³æ­¤ï¼ŒæœåŠ¡éƒ¨ç½²å®Œæˆã€‚
## 6.æœåŠ¡ç›‘æ§
Nebula ç¤¾åŒºæä¾›äº†ä¸€æ¬¾ç”¨äºç›‘æ§ NebulaGraph é›†ç¾¤ä¸­æœºå™¨å’ŒæœåŠ¡çŠ¶æ€çš„å¯è§†åŒ–å·¥å…· Dashboard ã€‚
ç›®å‰ä½œä¸ºå•èŠ‚ç‚¹æœåŠ¡ï¼Œå»ºè®®ä»…ç›‘æ§æœºå™¨æœ¬èº«çŠ¶æ€ã€‚
å› æ­¤å»ºè®®ç›‘æ§æ–¹æ¡ˆï¼šNode Exporter

## 7.æ•°æ®å¤‡ä»½
Nebula æä¾›äº†ä¸¤ç§å¤‡ä»½æ–¹æ¡ˆï¼š
- BR + Agentï¼šç¤¾åŒºæä¾›çš„å…¨é‡å¤‡ä»½å·¥å…·
- SNAPSHOTï¼šNebula è‡ªå¸¦çš„å¿«ç…§æŒ‡ä»¤
é€šè¿‡åˆæ­¥è°ƒç ”å‘ç°äºŒè€…å­˜åœ¨ä¸€å®šåŒºåˆ«ã€‚
ç¤¾åŒºå·¥å…·BRæ”¯æŒå…¨é‡å¤‡ä»½ä»¥åŠä¸€é”®æ¢å¤ã€‚è€ŒSNAPSHOTä»…æ”¯æŒå•ä¸ªç©ºé—´ä¸‹çš„æ•°æ®å¿«ç…§ï¼Œå¹¶ä¸”æ¢å¤æ—¶éœ€è¦æ‰‹åŠ¨æ‹·è´æ–‡ä»¶åˆ°æŒ‡å®šç›®å½•ï¼Œå­˜åœ¨ä¸€å®šçš„æ“ä½œé£é™©ã€‚
å› æ­¤æ­¤å¤„éƒ¨ç½²é‡‡ç”¨ç¤¾åŒºå¤‡ä»½å·¥å…·å®æ–½æ•°æ®å¤‡ä»½ï¼Œå¤‡ä»½æµç¨‹ä¸ºï¼š
1. æ‰§è¡Œå¤‡ä»½æŒ‡ä»¤
2. å¤‡ä»½æ–‡ä»¶å‹ç¼©
3. ä¸Šä¼ å¤‡ä»½æ•°æ®è‡³äº‘ç«¯
å¤‡ä»½è„šæœ¬åå‚è€ƒï¼š
```bash title="nebula-backup.sh"
#!/bin/bash

# è·å–å½“å‰æ—¥æœŸ
today=$(date +"%Y_%m_%d")

# è¿è¡Œå¤‡ä»½å‘½ä»¤
/usr/local/nebula/bin/br backup full --meta "127.0.0.1:9559" --storage "local:///usr/local/nebula/backup/"

# æ‰¾åˆ°ä»Šå¤©ç”Ÿæˆçš„æœ€æ–°å¤‡ä»½ç›®å½•
backup_dir=$(find /usr/local/nebula/backup/ -type d -name "BACKUP_${today}_*" | sort | tail -n 1)

# æ£€æŸ¥æ˜¯å¦æ‰¾åˆ°å¤‡ä»½ç›®å½•
if [ -z "$backup_dir" ]; then
echo "æœªæ‰¾åˆ°ä»Šå¤©ç”Ÿæˆçš„å¤‡ä»½ç›®å½•ã€‚"
exit 1
fi

# ç”Ÿæˆå‹ç¼©æ–‡ä»¶çš„åç§°
backup_name=$(basename $backup_dir)
tar_file="${backup_name}.tar.gz"

# ä½¿ç”¨ tar å‹ç¼©å¤‡ä»½ç›®å½•
tar -czvf /usr/local/nebula/backup/$tar_file -C $(dirname $backup_dir) $backup_name > /dev/null 2>&1

# æ£€æŸ¥æ˜¯å¦æˆåŠŸç”Ÿæˆå‹ç¼©æ–‡ä»¶
if [ -f "/usr/local/nebula/backup/$tar_file" ]; then
echo "æˆåŠŸå‹ç¼©ç›®å½• ${backup_dir} ä¸ºæ–‡ä»¶ /usr/local/nebula/backup/${tar_file}ã€‚"
else
echo "å‹ç¼©å¤±è´¥ã€‚"
exit 1
fi
```

## 8.é›†ç¾¤æ‹“å±•
Nebula é›†ç¾¤æ”¹é€ æœŸé—´éœ€è¦åœæœï¼ŒæœåŠ¡éœ€è¦ä¸­æ–­ã€‚
é›†ç¾¤æ­å»ºå¯ä»¥é€šè¿‡ä¿®æ”¹é…ç½®å®Œæˆï¼Œæš‚ä¸å…³æ³¨ã€‚
è€Œæ•´ä¸ªæ‰©å±•çš„æ ¸å¿ƒåœ¨äº storage ç»„ä»¶çš„æ•°æ®è´Ÿè½½æ˜¯å¦å‡è¡¡ã€‚
ç›®å‰ Nubula æ”¯æŒä½¿ç”¨å‘½ä»¤SUBMIT JOB BALANCE LEADERå‡è¡¡åˆ†å¸ƒæ‰€æœ‰å›¾ç©ºé—´ä¸­çš„ Leader åˆ†ç‰‡å‰¯æœ¬ã€‚ä½†é›†ç¾¤åœºæ™¯ä¸‹æ•ˆæœå¦‚ä½•ï¼Œå¾…éªŒè¯ã€‚



<br/>

:::info ğŸ‘‡ğŸ‘‡ğŸ‘‡
**æœ¬æ–‡ä½œè€…:** æ©™å­æ˜‚<br/>
**ç‰ˆæƒå£°æ˜:** è½¬è½½è¯·æ³¨æ˜å‡ºå¤„å“¦~ğŸ‘®â€ğŸ‘®â€ğŸ‘®â€
:::